name: Build OpenWrt (CMCC RAX3000M NAND é«˜åŠŸç‡ç‰ˆ)

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: 23.05-diy-part1.sh
  DIY_P2_SH: 23.05-diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  DEVICE_NAME: cmcc_rax3000m-nand

jobs:
  build:
    runs-on: ubuntu-22.04
    # æ–°å¢ï¼šæ­¥éª¤å¤±è´¥æ—¶ç»§ç»­ï¼Œä¾¿äºå®šä½æœ€ç»ˆé”™è¯¯
    continue-on-error: false

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment (ä¿®å¤å·¥å…·é“¾+ç‰ˆæœ¬å…¼å®¹)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # å¤ç”¨æ¨¡æ¿çš„æ¸…ç†é€»è¾‘ï¼Œæ–°å¢å·¥å…·é“¾ä¿®å¤
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        # å®‰è£…æ¨¡æ¿çš„åŸºç¡€ä¾èµ– + è¡¥å……ç³»ç»Ÿçº§bison/flex/m4ï¼ˆç§»é™¤ç‰ˆæœ¬é™åˆ¶ï¼‰
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2004) bison flex m4 libfl2 libfl-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        # éªŒè¯æ ¸å¿ƒä¾èµ–æ–‡ä»¶ï¼ˆè§£å†³m4sugar.m4ç¼ºå¤±ï¼‰
        if [ -f /usr/share/bison/m4sugar/m4sugar.m4 ]; then
          echo "âœ… ç³»ç»Ÿçº§bisonä¾èµ–æ–‡ä»¶å®Œæ•´"
        else
          sudo apt-get -qq install --reinstall bison bison-doc
        fi
        # æ–°å¢ï¼šå®‰è£…git-lfsï¼Œè§£å†³éƒ¨åˆ†Feedså…‹éš†å¤±è´¥
        sudo apt-get -qq install git-lfs > /dev/null 2>&1
        git lfs install > /dev/null 2>&1

    - name: Clone source code (å¤ç”¨æ¨¡æ¿è·¯å¾„é€»è¾‘+Feedsé¢„æ£€æŸ¥)
      working-directory: /workdir
      run: |
        df -hT $PWD
        # æ–°å¢ï¼šæµ…å…‹éš†æºç ï¼Œæå‡é€Ÿåº¦+å‡å°‘å¤±è´¥
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        # å…³é”®ä¿®å¤ï¼šç¦ç”¨OpenWrtå·¥å…·é“¾ç¼–è¯‘ï¼Œå¼ºåˆ¶ä½¿ç”¨ç³»ç»Ÿçº§å·¥å…·
        cd $GITHUB_WORKSPACE/openwrt
        # åˆ é™¤bison/flex/m4ç¼–è¯‘é¡¹
        sed -i '/^tools-y += / s/bison //; /^tools-y += / s/flex //; /^tools-y += / s/m4 //' tools/Makefile
        sed -i '/compile: / s/tools\/bison\/compile //; /compile: / s/tools\/flex\/compile //; /compile: / s/tools\/m4\/compile //' tools/Makefile
        # å¼ºåˆ¶ç³»ç»Ÿå·¥å…·è·¯å¾„ä¼˜å…ˆçº§
        echo 'export PATH=/usr/bin:/bin:/usr/sbin:/sbin:$(PATH)' >> include/host.mk
        # æ–°å¢ï¼šå¤‡ä»½åŸå§‹feeds.conf.defaultï¼Œé¿å…é‡å¤æ·»åŠ 
        cp -f feeds.conf.default feeds.conf.default.bak

    - name: Load custom feeds (ä¿®å¤Feedsæ·»åŠ é€»è¾‘+ä¸¥æ ¼æ ¡éªŒ)
      id: load_feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        # æ ¸å¿ƒä¿®å¤ï¼šæ‰§è¡ŒDIYè„šæœ¬æ—¶ä¸¥æ ¼æ ¡éªŒï¼Œå¤±è´¥åˆ™ç»ˆæ­¢ï¼ˆFeedsæ˜¯ç¼–è¯‘åŸºç¡€ï¼‰
        if ! $GITHUB_WORKSPACE/$DIY_P1_SH 2>&1 | tee diy_part1.log; then
          echo -e "\033[31mâŒ DIY-P1è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œç»ˆæ­¢ç¼–è¯‘ï¼\033[0m"
          cat diy_part1.log
          exit 1
        fi
        # æ–°å¢ï¼šæ£€æŸ¥Feedsç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œç¼ºå¤±åˆ™æ‰‹åŠ¨å…‹éš†
        FEEDS_CHECK_LIST=("small" "kenzo")
        for feed in "${FEEDS_CHECK_LIST[@]}"; do
          if [ ! -d "feeds/$feed" ]; then
            echo -e "\033[33mâš ï¸ Feeds/$feed ç¼ºå¤±ï¼Œå°è¯•æ‰‹åŠ¨å…‹éš†...\033[0m"
            case $feed in
              "small")
                git clone --depth 1 -b openwrt-23.05 https://github.com/kenzok8/small.git feeds/small || {
                  echo -e "\033[31mâŒ æ‰‹åŠ¨å…‹éš†small Feedså¤±è´¥ï¼Œç»ˆæ­¢ç¼–è¯‘\033[0m"
                  exit 1
                }
                ;;
              "kenzo")
                git clone --depth 1 -b openwrt-23.05 https://github.com/kenzok8/openwrt-packages.git feeds/kenzo || {
                  echo -e "\033[31mâŒ æ‰‹åŠ¨å…‹éš†kenzo Feedså¤±è´¥ï¼Œç»ˆæ­¢ç¼–è¯‘\033[0m"
                  exit 1
                }
                ;;
            esac
          fi
        done
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Update feeds (ä¿®å¤Feedsæ›´æ–°é€»è¾‘+é‡è¯•æœºåˆ¶)
      id: update_feeds
      run: |
        cd openwrt
        # æ–°å¢ï¼š3æ¬¡é‡è¯•æœºåˆ¶ï¼Œè§£å†³ç½‘ç»œæ³¢åŠ¨å¯¼è‡´çš„æ›´æ–°å¤±è´¥
        RETRY_COUNT=3
        RETRY_INTERVAL=5
        for ((i=1; i<=RETRY_COUNT; i++)); do
          echo -e "\033[32mğŸ”§ ç¬¬ $i æ¬¡æ›´æ–°Feeds...\033[0m"
          if ./scripts/feeds update -a 2>&1 | tee feeds_update.log; then
            echo -e "\033[32mâœ… Feedsæ›´æ–°æˆåŠŸï¼\033[0m"
            break
          fi
          if [ $i -eq $RETRY_COUNT ]; then
            echo -e "\033[31mâŒ Feedsæ›´æ–°å¤±è´¥ï¼ˆé‡è¯•$RETRY_COUNTæ¬¡ï¼‰ï¼Œç»ˆæ­¢ç¼–è¯‘ï¼\033[0m"
            cat feeds_update.log
            exit 1
          fi
          sleep $RETRY_INTERVAL
        done

    - name: Install feeds (ä¿®å¤Feedså®‰è£…é€»è¾‘+ç¼ºå¤±æ£€æŸ¥)
      id: install_feeds
      run: |
        cd openwrt
        # æ–°å¢ï¼šå…ˆå®‰è£…åŸºç¡€Feedsï¼Œå†å®‰è£…è‡ªå®šä¹‰Feeds
        if ! ./scripts/feeds install -a 2>&1 | tee feeds_install.log; then
          echo -e "\033[31mâŒ Feedså…¨é‡å®‰è£…å¤±è´¥ï¼Œç»ˆæ­¢ç¼–è¯‘ï¼\033[0m"
          cat feeds_install.log
          exit 1
        fi
        # å•ç‹¬å®‰è£…rtp2httpdï¼Œå¤±è´¥åˆ™æ‰‹åŠ¨å…‹éš†
        if ! ./scripts/feeds install rtp2httpd luci-app-rtp2httpd 2>&1 | tee rtp2httpd_install.log; then
          echo -e "\033[33mâš ï¸ è‡ªåŠ¨å®‰è£…rtp2httpdå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨å…‹éš†...\033[0m"
          mkdir -p package/custom/rtp2httpd
          git clone --depth 1 https://github.com/stackia/rtp2httpd.git package/custom/rtp2httpd || {
            echo -e "\033[31mâŒ æ‰‹åŠ¨å…‹éš†rtp2httpdå¤±è´¥ï¼Œç»ˆæ­¢ç¼–è¯‘\033[0m"
            exit 1
          }
        fi
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Load custom configuration (å¤ç”¨æ¨¡æ¿é€»è¾‘+æ³¨å…¥è®¾å¤‡é…ç½®)
      id: load_config
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        # æ³¨å…¥RAX3000Mè®¾å¤‡é…ç½®
        sed -i '/CONFIG_TARGET_mediatek_filogic_DEVICE_/d' .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${DEVICE_NAME}=y" >> .config
        # æ‰§è¡ŒDIY-P2è„šæœ¬ï¼Œå¤±è´¥åˆ™ç»ˆæ­¢
        if ! $GITHUB_WORKSPACE/$DIY_P2_SH 2>&1 | tee diy_part2.log; then
          echo -e "\033[31mâŒ DIY-P2è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œç»ˆæ­¢ç¼–è¯‘ï¼\033[0m"
          cat diy_part2.log
          exit 1
        fi
        # æ–°å¢ï¼šéªŒè¯æ ¸å¿ƒé…ç½®æ˜¯å¦å­˜åœ¨
        if ! grep -q "CONFIG_TARGET_mediatek_filogic_DEVICE_${DEVICE_NAME}=y" .config; then
          echo -e "\033[31mâŒ è®¾å¤‡é…ç½®æ³¨å…¥å¤±è´¥ï¼Œç»ˆæ­¢ç¼–è¯‘ï¼\033[0m"
          exit 1
        fi
        echo "status=success" >> $GITHUB_OUTPUT

    - name: SSH connection to Actions (å¤ç”¨æ¨¡æ¿é€»è¾‘)
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download package (å¤ç”¨æ¨¡æ¿+å•çº¿ç¨‹ä¿®å¤+é‡è¯•)
      id: package
      run: |
        cd openwrt
        # å¼ºåˆ¶ä½¿ç”¨ç³»ç»Ÿå·¥å…·ç”Ÿæˆé…ç½®
        export PATH=/usr/bin:/bin:/usr/sbin:/sbin
        make defconfig || {
          echo -e "\033[31mâŒ ç”Ÿæˆé»˜è®¤é…ç½®å¤±è´¥ï¼Œç»ˆæ­¢ç¼–è¯‘ï¼\033[0m"
          exit 1
        }
        # æ–°å¢ï¼š3æ¬¡é‡è¯•ä¸‹è½½ä¾èµ–ï¼Œè§£å†³ç½‘ç»œé—®é¢˜
        RETRY_COUNT=3
        RETRY_INTERVAL=10
        for ((i=1; i<=RETRY_COUNT; i++)); do
          echo -e "\033[32mğŸ”§ ç¬¬ $i æ¬¡ä¸‹è½½ä¾èµ–åŒ…...\033[0m"
          if make download -j1 2>&1 | tee download.log; then
            echo -e "\033[32mâœ… ä¾èµ–ä¸‹è½½æˆåŠŸï¼\033[0m"
            break
          fi
          if [ $i -eq $RETRY_COUNT ]; then
            echo -e "\033[31mâŒ ä¾èµ–ä¸‹è½½å¤±è´¥ï¼ˆé‡è¯•$RETRY_COUNTæ¬¡ï¼‰ï¼Œç»ˆæ­¢ç¼–è¯‘ï¼\033[0m"
            cat download.log
            exit 1
          fi
          sleep $RETRY_INTERVAL
        done
        # æ¸…ç†æ— æ•ˆä¾èµ–
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Compile the firmware (æ ¸å¿ƒä¿®å¤ï¼šå•çº¿ç¨‹+ç³»ç»Ÿå·¥å…·+è¯¦ç»†æ—¥å¿—)
      id: compile
      run: |
        cd openwrt
        # å…¨ç¨‹å¼ºåˆ¶ç³»ç»Ÿå·¥å…·è·¯å¾„
        export PATH=/usr/bin:/bin:/usr/sbin:/sbin
        # å¤ç”¨æ¨¡æ¿çš„ç¼–è¯‘é™çº§é€»è¾‘ï¼Œä½†é»˜è®¤å•çº¿ç¨‹ï¼ˆç¨³å®šä¼˜å…ˆï¼‰
        echo -e "\033[32mğŸ”§ å¼€å§‹å•çº¿ç¨‹ç¼–è¯‘RAX3000Må›ºä»¶...\033[0m"
        # æ–°å¢ï¼šè¾“å‡ºç¼–è¯‘è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºå®šä½é”™è¯¯
        make -j1 V=s 2>&1 | tee compile.log || {
          echo -e "\033[31mâŒ å›ºä»¶ç¼–è¯‘å¤±è´¥ï¼Œå…³é”®æ—¥å¿—å¦‚ä¸‹ï¼š\033[0m"
          tail -200 compile.log
          exit 1
        }
        # éªŒè¯ç¼–è¯‘äº§ç‰©æ˜¯å¦å­˜åœ¨
        if [ ! -d "bin/targets" ]; then
          echo -e "\033[31mâŒ æœªç”Ÿæˆç¼–è¯‘äº§ç‰©ï¼Œç»ˆæ­¢ç¼–è¯‘ï¼\033[0m"
          exit 1
        fi
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Check space usage (å¤ç”¨æ¨¡æ¿é€»è¾‘)
      if: (!cancelled())
      run: df -hT

    - name: Upload bin directory (å¤ç”¨æ¨¡æ¿é€»è¾‘)
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Organize files (ä¿®å¤è·¯å¾„ä¸å­˜åœ¨+ä¸¥æ ¼æ ¡éªŒ)
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        # æ–°å¢ï¼šæ£€æŸ¥ç¼–è¯‘äº§ç‰©è·¯å¾„æ˜¯å¦å­˜åœ¨
        FIRMWARE_PATH="openwrt/bin/targets/mediatek/filogic"
        if [ ! -d "$FIRMWARE_PATH" ]; then
          echo -e "\033[31mâŒ å›ºä»¶è·¯å¾„ $FIRMWARE_PATH ä¸å­˜åœ¨ï¼Œç»ˆæ­¢æ•´ç†ï¼\033[0m"
          exit 1
        fi
        cd "$FIRMWARE_PATH"
        # æ¸…ç†å†—ä½™æ–‡ä»¶
        rm -rf packages *.buildinfo *.manifest *.json *bl2.bin
        # ä»…ä¿ç•™RAX3000Mçš„sysupgradeå›ºä»¶ï¼ˆç²¾ç®€ï¼‰
        FIRMWARE_FILES=$(ls *cmcc_rax3000m*sysupgrade*.bin 2>/dev/null | wc -l)
        if [ $FIRMWARE_FILES -eq 0 ]; then
          echo -e "\033[31mâŒ æœªæ‰¾åˆ°RAX3000M sysupgradeå›ºä»¶ï¼Œç»ˆæ­¢æ•´ç†ï¼\033[0m"
          exit 1
        fi
        rm -rf !(*cmcc_rax3000m*sysupgrade*.bin)
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory (å¤ç”¨æ¨¡æ¿é€»è¾‘)
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: Upload firmware to cowtransfer (å¤ç”¨æ¨¡æ¿é€»è¾‘)
      id: cowtransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

    - name: Upload firmware to WeTransfer (å¤ç”¨æ¨¡æ¿é€»è¾‘)
      id: wetransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "url=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

    - name: Generate release tag (é€‚é…RAX3000Må›ºä»¶ä¿¡æ¯)
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M-immortalwrt23.05-cmcc_rax3000m-nand")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "CMCC RAX3000M NANDç‰ˆ é«˜åŠŸç‡å›ºä»¶" >> release.txt
        echo "åå°ï¼š192.168.1.1ï¼ˆé»˜è®¤ï¼‰/ 192.168.6.1ï¼ˆå¯é€‰ï¼‰" >> release.txt
        echo "è´¦å·ï¼šroot" >> release.txt
        echo "å¯†ç ï¼šæ— " >> release.txt
        echo "å†…æ ¸ç‰ˆæœ¬ï¼š5.15.195" >> release.txt
        echo "MT76é©±åŠ¨ï¼š7a71a9fï¼ˆé«˜åŠŸç‡ç‰ˆï¼‰" >> release.txt
        echo "WiFiåŠŸç‡ï¼š2.4G=28dBm / 5G=26dBm" >> release.txt
        echo "ç¼–è¯‘æºç ï¼šhttps://github.com/immortalwrt/immortalwrt (openwrt-23.05)" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release (å¤ç”¨æ¨¡æ¿é€»è¾‘)
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Upload debug logs (æ–°å¢ï¼šä¸Šä¼ æ‰€æœ‰è°ƒè¯•æ—¥å¿—)
      uses: actions/upload-artifact@main
      if: !cancelled()
      with:
        name: Compile_Debug_Logs_${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: |
          openwrt/diy_part1.log
          openwrt/diy_part2.log
          openwrt/feeds_update.log
          openwrt/feeds_install.log
          openwrt/download.log
          openwrt/compile.log
          openwrt/rtp2httpd_install.log
        retention-days: 7

    - name: Delete workflow runs (å¤ç”¨æ¨¡æ¿é€»è¾‘)
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3
